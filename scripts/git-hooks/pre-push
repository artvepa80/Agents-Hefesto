#!/usr/bin/env bash
set -euo pipefail

# Allow bypass
if [[ "${SKIP_HEFESTO_HOOKS:-0}" == "1" ]]; then
  echo "[hefesto] SKIP_HEFESTO_HOOKS=1 set; skipping pre-push checks."
  exit 0
fi

ROOT="$(git rev-parse --show-toplevel)"

# Prefer local venv if present
if [[ -x "$ROOT/.venv/bin/python" ]]; then
  PY="$ROOT/.venv/bin/python"
elif command -v python3 >/dev/null 2>&1; then
  PY="python3"
else
  PY="python"
fi

run() {
  echo "[hefesto] $*"
  "$@"
}

cd "$ROOT"

# Hefesto self-analysis (dogfooding) - fails on CRITICAL security issues only
# Excludes complexity-related types (VERY_HIGH_COMPLEXITY, LONG_FUNCTION) which are quality debt, not exploits
echo "[hefesto] Running Hefesto security gate..."
hefesto analyze hefesto/ --fail-on CRITICAL --quiet --exclude-types VERY_HIGH_COMPLEXITY,LONG_FUNCTION
echo "[hefesto] Hefesto security gate passed."

# Optional: timeout if available (Linux); otherwise run normally
if command -v timeout >/dev/null 2>&1; then
  T="timeout 120"
else
  T=""
fi

# Fast gate (CI enforces full gate)
$T $PY -m black --check hefesto tests omega
$T $PY -m isort --check-only hefesto tests omega
$T $PY -m flake8 hefesto tests omega
$T $PY -m mypy hefesto omega --ignore-missing-imports
$T $PY -m pytest -q --tb=short --maxfail=1 tests/api/test_health.py tests/test_sql_analyzer.py

echo "[hefesto] Pre-push checks OK."
